{% extends "cars/base.html" %}
{% load static %}

{% block content %}
<!-- ВСТАВКА Bootstrap Icons и СТИЛЕЙ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
  .custom-select-wrapper {
    position: relative;
  }

  .custom-select-wrapper select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: none !important;
    padding-right: 2.5rem;
  }

  .dropdown-icon {
    position: absolute;
    top: 50%;
    right: 1rem;
    transform: translateY(-50%);
    pointer-events: none;
    font-size: 18px;
    color: #6c757d;
    z-index: 2;
  }
</style>

<h2 class="mb-4 text-center">Жеке кабинет</h2>

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-success text-center">{{ message }}</div>
  {% endfor %}
{% endif %}

<form method="post" enctype="multipart/form-data" class="card shadow-sm p-4">
  {% csrf_token %}
  <div class="text-center mb-4">
    {% if employee.avatar %}
      <img src="{{ employee.avatar.url }}" alt="avatar" class="rounded-circle shadow" width="150" height="150">
    {% else %}
      <img src="https://via.placeholder.com/150" alt="avatar" class="rounded-circle shadow" width="150" height="150">
    {% endif %}

    <!-- Кастомная загрузка файла -->
    <div class="mt-3">
      <label for="custom-file-upload" class="btn btn-outline-secondary w-100">Файлды таңдаңыз</label>
      <input type="file" id="custom-file-upload" name="avatar" style="display: none;">
      <div id="file-name" class="form-text mt-1">Файл таңдалмады</div>
    </div>
  </div>

  <div class="card-body">
    <div class="mb-3">
      <label class="form-label">Тегі</label>
      <input type="text" name="first_name" value="{{ request.user.first_name }}" class="form-control">
    </div>

    <div class="mb-3">
      <label class="form-label">Аты</label>
      <input type="text" name="username" value="{{ request.user.username }}" class="form-control">
    </div>

    <div class="mb-3">
      <label class="form-label">Әкесінің аты</label>
      <input type="text" name="last_name" value="{{ request.user.last_name }}" class="form-control">
    </div>

    <div class="form-group">
      <label for="phone"> Телефон нөмірі:</label>
      <input type="text" name="phone" value="{{ employee.phone }}" class="form-control" placeholder="+7 777 555 4433">
    </div>

    <div class="mb-3">
      <label class="form-label">Электрондық поштасы</label>
      <input type="email" name="email" value="{{ request.user.email }}" class="form-control" oninput="checkEmailUnique(this)">
      <div id="email-warning" class="text-danger mt-1"></div>
    </div>

    <!-- Рөлі -->
    <div class="mb-3">
      <label class="form-label">Рөлі</label>
      <div class="custom-select-wrapper">
        <select name="role" class="form-control">
          <option value="user" {% if employee.role == 'user' %}selected{% endif %}>Қолданушы</option>
          <option value="guest" {% if employee.role == 'guest' %}selected{% endif %}>Қонақ</option>
        </select>
        <i class="bi bi-caret-down-fill dropdown-icon"></i>
      </div>
    </div>

    <div class="mb-3">
      <label class="form-label">Байланыс ақпараты</label>
      <textarea name="contact_info" class="form-control" rows="3">{{ employee.contact_info }}</textarea>
    </div>
  </div>

  <div class="d-flex justify-content-center gap-5 mt-4">
    <button type="submit" class="btn btn-success" name="saveBtn" id="saveBtn">
      <i class="bi bi-check-circle me-1"></i> Өзгерістерді сақтау
    </button>
    <button type="submit" class="btn btn-secondary" name="backBtn">
      <i class="bi bi-arrow-left-circle me-1"></i> Басты бетке қайту
    </button>
  </div>

  <div id="save-success" class="alert alert-success text-center mt-3 d-none">Профиль жаңартылды!</div>
</form>

<script>
function checkEmailUnique(input) {
  const email = input.value;
  fetch(`/check-email/?email=${encodeURIComponent(email)}`)
    .then(res => res.json())
    .then(data => {
      let warning = document.getElementById('email-warning');
      let saveBtn = document.getElementById('saveBtn');
      let successMsg = document.getElementById('save-success');
      if (!warning) {
        warning = document.createElement('div');
        warning.id = 'email-warning';
        warning.className = 'text-danger mt-1';
        input.parentElement.appendChild(warning);
      }
      if (data.exists) {
        warning.innerText = 'Мұндай Email қолданыста бар';
        saveBtn.disabled = true;
        if (successMsg) successMsg.classList.add('d-none');
      } else {
        warning.innerText = '';
        saveBtn.disabled = false;
        if (successMsg) {
          successMsg.classList.remove('d-none');
          setTimeout(() => successMsg.classList.add('d-none'), 3000);
        }
      }
    });
}

const fileInput = document.getElementById("custom-file-upload");
const fileNameDisplay = document.getElementById("file-name");

if (fileInput && fileNameDisplay) {
  fileInput.addEventListener("change", function () {
    const name = this.files.length ? this.files[0].name : "Файл таңдалмады";
    fileNameDisplay.textContent = name;
  });
}
</script>
{% endblock %}
