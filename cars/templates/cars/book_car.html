{% extends "cars/base.html" %}
{% load static %}
{% block content %}

<div class="container mt-5">
  <h2 class="text-center mb-4">–ê–≤—Ç–æ–∫”©–ª—ñ–∫—Ç—ñ –±—Ä–æ–Ω–¥–∞—É</h2>

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="–ñ–∞–±—É"></button>
      </div>
    {% endfor %}
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title">{{ car.brand }} {{ car.model }}</h5>
      <p class="card-text">–®—ã“õ“õ–∞–Ω –∂—ã–ª—ã: {{ car.year }} | –¢–∏–ø: {{ car.car_type }}</p>
      <p class="card-text">–ë–∞“ì–∞—Å—ã –∫“Ø–Ω—ñ–Ω–µ: <strong id="pricePerDay">{{ car.price_per_day }}</strong> ‚Ç∏</p>

      <form method="post" oninput="calculateTotal()">
        {% csrf_token %}
        <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ -->
        <input type="hidden" id="start_datetime" name="start_datetime">
        <div class="mb-3">
          <label for="start_date" class="form-label">–ñ–∞–ª“ì–∞ –∞–ª—É–¥—ã“£ –±–∞—Å—Ç–∞–ª—É –∫“Ø–Ω—ñ</label>
          <input type="date" id="start_date" name="start_date" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">–ê“ì—ã–º–¥–∞“ì—ã —É–∞“õ—ã—Ç:</label>
          <div id="current-time" class="form-control bg-light"></div>
        </div>
        <div class="mb-3">
          <label for="end_date" class="form-label">–ñ–∞–ª“ì–∞ –∞–ª—É–¥—ã“£ –∞—è“õ—Ç–∞–ª—É –∫“Ø–Ω—ñ</label>
          <input type="date" id="end_date" name="end_date" class="form-control" required>
        </div>
        <div class="mb-3">
          <label for="id_address" class="form-label">–ú–µ–∫–µ–Ω–∂–∞–π</label>
          <input type="text" id="id_address" name="location" class="form-control" placeholder="–ê–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ —Ç–æ–ª—Ç—ã—Ä—ã–ª–∞–¥—ã" required>
        </div>

        <div class="mb-3">
          <label for="id_coordinates" class="form-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—Ç–∞—Ä—ã</label>
          <input type="text" id="id_coordinates" name="coordinates" class="form-control" placeholder="43.255000, 76.950000" required>
        </div>

        <div id="map" style="height: 300px; margin-top: 20px; border-radius: 8px;"></div>

        <div class="alert alert-info" id="summary" style="display: none;">
          <span id="daysCount"></span> –∫“Ø–Ω √ó <span id="priceDay"></span> ‚Ç∏ = <strong><span id="totalPrice"></span> ‚Ç∏</strong>
        </div>
        {% if user.is_authenticated %}
        <div class="d-flex justify-content-center gap-4 mt-4">
          <button type="submit" class="btn btn-success" id="saveBtn">
            <i class="bi bi-calendar-check me-1"></i> –ë—Ä–æ–Ω–¥–∞—É
          </button>
          <a href="{% url 'home' %}" class="btn btn-secondary">
            <i class="bi bi-arrow-left-circle me-1"></i> –ë–∞—Å—Ç—ã –±–µ—Ç–∫–µ “õ–∞–π—Ç—É
          </a>
        </div>
        {% else %}
          <a href="{% url 'login' %}" class="btn btn-outline-secondary w-100">
            <i class="bi bi-lock me-1"></i> –ö—ñ—Ä—É –∞—Ä“õ—ã–ª—ã –±—Ä–æ–Ω–¥–∞—É
          </a>
        {% endif %}
      </form>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    const pricePerDay = parseFloat(document.getElementById('pricePerDay').textContent);
    const startDatetimeHidden = document.getElementById('start_datetime');

    function updateCurrentTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      const timeDisplay = document.getElementById('current-time');
      if (timeDisplay) {
        timeDisplay.textContent = `${hours}:${minutes}:${seconds}`;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Å datetime, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–∞—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞
      const datetimeInput = document.getElementById('start_datetime');
      const startDateInput = document.getElementById('start_date');
      if (datetimeInput && startDateInput.value) {
        const isoTime = now.toTimeString().split(' ')[0];  // HH:MM:SS
        const fullDateTime = `${startDateInput.value}T${isoTime}`;
        datetimeInput.value = fullDateTime;
      }
    }

    function calculateTotal() {
      const start = startDateInput.value;
      const end = endDateInput.value;
      const summary = document.getElementById('summary');
      const daysCountEl = document.getElementById('daysCount');
      const totalPriceEl = document.getElementById('totalPrice');
      const priceDayEl = document.getElementById('priceDay');

      if (start && end) {
        const startDate = new Date(start);
        const endDate = new Date(end);
        const diffTime = endDate - startDate;
        const days = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        if (days >= 0) {
          summary.style.display = 'block';
          daysCountEl.textContent = days + 1;
          priceDayEl.textContent = pricePerDay.toFixed(2);
          totalPriceEl.textContent = ((days + 1) * pricePerDay).toFixed(2);
        } else {
          summary.style.display = 'none';
        }
      } else {
        summary.style.display = 'none';
      }
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –¥–∞—Ç–µ
    const today = new Date().toISOString().split('T')[0];
    startDateInput.min = today;
    endDateInput.min = today;

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ä–∞—Å—á–µ—Ç–∞
    setInterval(updateCurrentTime, 1000);
    startDateInput.addEventListener('input', updateCurrentTime);
    startDateInput.addEventListener('input', calculateTotal);
    endDateInput.addEventListener('input', calculateTotal);

    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateCurrentTime();
    setInterval(updateCurrentTime, 1000);
    calculateTotal();
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const addressField = document.getElementById("id_address");
  const coordinatesField = document.getElementById("id_coordinates");

  if (!navigator.geolocation) {
    console.warn("üõë –ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
    if (addressField) {
      addressField.value = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –µ–º–µ—Å";
    }
    return;
  }

  navigator.geolocation.getCurrentPosition(
    function (position) {
      const lat = position.coords.latitude.toFixed(6);
      const lng = position.coords.longitude.toFixed(6);

      if (coordinatesField) {
        coordinatesField.value = `${lat}, ${lng}`;
      }

      const apiKey = "AIzaSyBVNcvi0RV8gb1MuBXNWUrJnIZS5sVlLlQ";  // –ó–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á!
      const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&language=ru&key=${apiKey}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.status === "OK" && data.results.length > 0) {
            const formatted = data.results[0].formatted_address;
            if (addressField && formatted) {
              addressField.value = formatted;
              console.log("‚úÖ –ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω:", formatted);
            }
          } else {
            console.warn("‚ö†Ô∏è –ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, —Å—Ç–∞—Ç—É—Å:", data.status);
            if (addressField && !addressField.value) {
              addressField.value = "–ê–¥—Ä–µ—Å –∞–Ω—ã“õ—Ç–∞–ª–º–∞–¥—ã";
            }
          }
        })
        .catch(error => {
          console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Google API:", error);
          if (addressField && !addressField.value) {
            addressField.value = "“ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã";
          }
        });
    },
    function (error) {
      console.error("üõë –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", error.message);
      if (addressField) {
        addressField.value = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è ”©—à—ñ—Ä—ñ–ª–≥–µ–Ω";
      }
    }
  );
});
</script>

<!-- Google Maps API (–ø–æ–¥—Å—Ç–∞–≤—å —Å–≤–æ–π API –∫–ª—é—á) -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBVNcvi0RV8gb1MuBXNWUrJnIZS5sVlLlQ"></script>

<script>
function initMapAtCoords(lat, lng) {
  const mapDiv = document.getElementById("map");
  if (!mapDiv) return;

  const position = { lat: parseFloat(lat), lng: parseFloat(lng) };

  const map = new google.maps.Map(mapDiv, {
    zoom: 16,
    center: position,
  });

  new google.maps.Marker({
    position: position,
    map: map,
    title: "–°—ñ–∑–¥—ñ“£ –æ—Ä–Ω–∞–ª–∞—Å—É—ã“£—ã–∑",
  });
}

document.addEventListener("DOMContentLoaded", function () {
  const addressField = document.getElementById("id_address");
  const coordinatesField = document.getElementById("id_coordinates");

  if (!navigator.geolocation) {
    addressField.value = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è “õ–æ–ª–∂–µ—Ç—ñ–º–¥—ñ –µ–º–µ—Å";
    return;
  }

  navigator.geolocation.getCurrentPosition(
    function (position) {
      const lat = position.coords.latitude.toFixed(6);
      const lng = position.coords.longitude.toFixed(6);

      if (coordinatesField) {
        coordinatesField.value = `${lat}, ${lng}`;
      }

      initMapAtCoords(lat, lng);  // üëâ –¥–æ–±–∞–≤–ª–µ–Ω–æ –∑–¥–µ—Å—å, –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç

      const apiKey = "AIzaSyBVNcvi0RV8gb1MuBXNWUrJnIZS5sVlLlQ";
      const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&language=ru&key=${apiKey}`;

      fetch(url)
        .then(response => response.json())
        .then(data => {
          if (data.status === "OK" && data.results.length > 0) {
            const formatted = data.results[0].formatted_address;
            if (addressField && formatted) {
              addressField.value = formatted;
              console.log("‚úÖ –ê–¥—Ä–µ—Å –æ–ø—Ä–µ–¥–µ–ª—ë–Ω:", formatted);
            }
          } else {
            console.warn("‚ö†Ô∏è –ê–¥—Ä–µ—Å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω, —Å—Ç–∞—Ç—É—Å:", data.status);
            if (addressField && !addressField.value) {
              addressField.value = "–ê–¥—Ä–µ—Å –∞–Ω—ã“õ—Ç–∞–ª–º–∞–¥—ã";
            }
          }
        })
        .catch(error => {
          console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Google API:", error);
          if (addressField && !addressField.value) {
            addressField.value = "“ö–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã";
          }
        });
    },
    function (error) {
      console.error("üõë –û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏:", error.message);
      if (addressField) {
        addressField.value = "–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è ”©—à—ñ—Ä—ñ–ª–≥–µ–Ω";
      }
    }
  );
});
</script>




{% endblock %}